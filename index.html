import React, { useState, useEffect } from 'react';
import { 
  Dumbbell, 
  Play, 
  Settings, 
  Moon, 
  Sun, 
  ChevronUp, 
  CheckCircle, 
  Pause, 
  RotateCcw, 
  Menu, 
  X,
  Download,
  Trophy,
  Disc,
  BookOpen,
  Activity
} from 'lucide-react';

// --- DATA STRUCTURES ---

const ROUTINES = {
  chest: {
    id: 'chest',
    title: "Pecho y Tríceps",
    image: "PechoYTriceps1.jpg",
    description: "Enfoque en empuje pesado y aislamiento muscular.",
    blocks: [
      {
        title: "Bloque 1 – Fuerza Pectoral",
        exercises: [
          { name: "Press banca unilateral en máquina", details: "6x5 rep, 80–85% RM" },
          { name: "Press inclinado con mancuernas", details: "5x8 rep" }
        ]
      },
      {
        title: "Bloque 2 – Hipertrofia Pectoral",
        exercises: [
          { name: "Press en máquina convergente", details: "4x10–12 rep" },
          { name: "Peck deck", details: "3x10 rep + dropset" },
          { name: "Peck deck de pie", details: "3x al fallo" }
        ]
      },
      {
        title: "Bloque 3 – Tríceps",
        exercises: [
          { name: "Press cerrado en banca", details: "5x8–10 rep" },
          { name: "Press francés con barra Z", details: "4x10–12 rep" },
          { name: "Extensiones en polea con cuerda", details: "4x12–15 rep" },
          { name: "Extensión overhead con mancuerna", details: "4x12–15 rep" }
        ]
      },
      {
        title: "Bloque 4 – Finisher",
        exercises: [
          { name: "Press JM", details: "4x8–10 rep, peso moderado" }
        ]
      }
    ]
  },
  back: {
    id: 'back',
    title: "Espalda y Bíceps",
    image: "EspaldaYBiceps1.jpg",
    description: "Construcción de amplitud y densidad dorsal.",
    blocks: [
      {
        title: "Bloque 1 – Espalda (Tirón)",
        exercises: [
          { name: "Jalón al pecho abierto", details: "2 series al fallo + parciales" },
          { name: "Remo Gironda", details: "2 series al fallo + parciales" },
          { name: "Remo en punta", details: "2 series al fallo" }
        ]
      },
      {
        title: "Bloque 2 – Unilateral y Estiramiento",
        exercises: [
          { name: "Remo unilateral en máquina", details: "3 series" },
          { name: "Pullover unilateral en polea alta", details: "3 series al fallo con dropset" }
        ]
      },
      {
        title: "Bloque 3 – Bíceps",
        exercises: [
          { name: "Predicador con barra Z/mancuernas", details: "3 series al fallo" },
          { name: "Curl inclinado con mancuernas", details: "3 series al fallo" }
        ]
      },
      {
        title: "Bloque 4 – Finisher",
        exercises: [
          { name: "Peso muerto convencional (Bombeo)", details: "3–4x12–15 rep, 60–70% RM" }
        ]
      }
    ]
  },
  legs: {
    id: 'legs',
    title: "Pierna",
    image: "Pierna1.jpg",
    description: "Entrenamiento completo de tren inferior.",
    blocks: [
      {
        title: "Bloque 1 – Isquiotibiales",
        exercises: [
          { name: "Curl femoral sentado", details: "2x6–8 rep al fallo + parciales" },
          { name: "Curl femoral tumbado", details: "2x6–8 rep al fallo + parciales" }
        ]
      },
      {
        title: "Bloque 2 – Cuádriceps",
        exercises: [
          { name: "Hack Squat", details: "3x6–8 rep al fallo" },
          { name: "Squat en multipower", details: "3x6–8 rep al fallo" }
        ]
      },
      {
        title: "Bloque 3 – Peso muerto / Glúteo",
        exercises: [
          { name: "Peso muerto rumano con cinturón", details: "3x6–8 rep" }
        ]
      },
      {
        title: "Bloque 4 – Aislantes y Accesorios",
        exercises: [
          { name: "Extensión de cuádriceps", details: "3 series + dropset" },
          { name: "Abductores y aductores", details: "3 series + dropset" },
          { name: "Gemelos", details: "3 series de 30 segundos" }
        ]
      }
    ]
  },
  delts: {
    id: 'delts',
    title: "Deltoides y Trapecio",
    image: "DeltoidesYTrapecio1.jpg",
    description: "Hombros 3D y trapecios potentes.",
    blocks: [
      {
        title: "Bloque 1 – Deltoide Anterior / Fuerza",
        exercises: [
          { name: "Press militar con barra", details: "5x6–8 rep" },
          { name: "Press con mancuernas sentado", details: "4x8–10 rep" }
        ]
      },
      {
        title: "Bloque 2 – Deltoide Lateral / Aislantes",
        exercises: [
          { name: "Elevaciones laterales", details: "4x12–15 rep" },
          { name: "Pájaros o elevaciones posteriores", details: "4x12–15 rep" },
          { name: "Face Pulls", details: "3–4x12–15 rep" }
        ]
      },
      {
        title: "Bloque 3 – Trapecio / Bombeo",
        exercises: [
          { name: "Encogimientos con barra/mancuernas", details: "4x12–15 rep" },
          { name: "Remo al mentón", details: "3x10–12 rep" }
        ]
      },
      {
        title: "Bloque 4 – Finisher",
        exercises: [
          { name: "Elevaciones frontales", details: "2–3x10–12 rep" },
          { name: "Press banca moderado", details: "2–3x10–12 rep" }
        ]
      }
    ]
  }
};

const MOTIVATIONAL_QUOTES = [
  "El dolor es temporal, la satisfacción es para siempre.",
  "Tu único límite es tu mente.",
  "No cuentes los días, haz que los días cuenten.",
  "Disciplina es hacer lo que tienes que hacer, incluso cuando no quieres.",
  "La mejor versión de ti mismo te está esperando."
];

// --- UTILS ---

const formatTime = (seconds) => {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
};

const exportToCSV = (history) => {
  if (!history || history.length === 0) {
    alert("No hay datos para exportar.");
    return;
  }

  let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
  csvContent += "Fecha,Rutina,Ejercicio,Series,Repeticiones,Peso(kg),Notas\n";

  history.forEach(session => {
    const date = new Date(session.date).toLocaleDateString();
    const routineName = session.routineName;
    const notes = session.notes ? session.notes.replace(/(\r\n|\n|\r)/gm, " ") : ""; 
    
    Object.keys(session.exercises).forEach(exName => {
      const exData = session.exercises[exName];
      csvContent += `${date},"${routineName}","${exName}",${exData.sets || 0},${exData.reps || 0},"${exData.weight || 0}","${notes}"\n`;
    });
  });

  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "anzos_style_data.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

// --- EXTERNAL COMPONENTS ---

const InitialLoader = ({ onFinish }) => {
  useEffect(() => {
    const timer = setTimeout(onFinish, 2500);
    return () => clearTimeout(timer);
  }, [onFinish]);

  return (
    <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black text-gold-500">
      <div className="animate-pulse mb-4">
        <Dumbbell size={64} className="text-amber-500" />
      </div>
      <h1 className="text-4xl font-serif tracking-widest text-amber-500 animate-fade-in-up">
        ANZO'S STYLE
      </h1>
      <p className="text-gray-400 mt-2 font-light tracking-wider text-sm">
        Construyendo tu mejor versión
      </p>
    </div>
  );
};

const Toast = ({ message, show, onClose }) => {
  useEffect(() => {
    if (show) {
      const timer = setTimeout(onClose, 3000);
      return () => clearTimeout(timer);
    }
  }, [show, onClose]);

  if (!show) return null;

  return (
    <div className="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-amber-600 text-white px-6 py-3 rounded-full shadow-xl z-50 animate-bounce-short flex items-center gap-2 whitespace-nowrap">
      <CheckCircle size={20} />
      <span>{message}</span>
    </div>
  );
};

const PlateCalculator = ({ onClose, cardClass }) => {
  const [targetWeight, setTargetWeight] = useState('');
  const [barWeight, setBarWeight] = useState(20);
  const [results, setResults] = useState(null);

  const calculatePlates = () => {
    if (!targetWeight || targetWeight < barWeight) {
      setResults(null);
      return;
    }

    let weightPerSide = (targetWeight - barWeight) / 2;
    const plates = [25, 20, 15, 10, 5, 2.5, 1.25];
    const calculated = [];

    plates.forEach(plate => {
      while (weightPerSide >= plate) {
        calculated.push(plate);
        weightPerSide -= plate;
      }
    });

    setResults(calculated);
  };

  useEffect(() => {
    calculatePlates();
  }, [targetWeight, barWeight]);

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
      <div className={`w-full max-w-sm p-6 rounded-xl shadow-2xl border ${cardClass}`}>
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-serif font-bold flex items-center gap-2">
            <Disc className="text-amber-500" /> Calc. Discos
          </h2>
          <button onClick={onClose}><X size={24} /></button>
        </div>

        <div className="space-y-4">
          <div>
            <label className="text-xs uppercase opacity-60 mb-1 block">Peso Total (kg)</label>
            <input 
              type="number" 
              value={targetWeight} 
              onChange={e => setTargetWeight(e.target.value)}
              className="w-full p-3 rounded-lg bg-stone-500/10 text-2xl font-bold text-center focus:outline-none focus:ring-2 focus:ring-amber-500"
              placeholder="Ej: 80"
              autoFocus
            />
          </div>
          
          <div className="flex justify-center gap-4 text-sm">
             <button 
               onClick={() => setBarWeight(20)} 
               className={`px-3 py-1 rounded-full border transition-colors ${barWeight === 20 ? 'bg-amber-500 text-white border-amber-500' : 'border-stone-500/30'}`}
             >Barra 20kg</button>
             <button 
               onClick={() => setBarWeight(15)} 
               className={`px-3 py-1 rounded-full border transition-colors ${barWeight === 15 ? 'bg-amber-500 text-white border-amber-500' : 'border-stone-500/30'}`}
             >Barra 15kg</button>
          </div>

          <div className="mt-6 p-4 bg-stone-500/5 rounded-lg min-h-[120px] flex flex-col items-center justify-center">
            {results && results.length > 0 ? (
              <>
                <p className="text-sm opacity-60 mb-3">POR LADO:</p>
                <div className="flex flex-wrap justify-center gap-2 animate-slide-up">
                  {results.map((plate, idx) => (
                    <div key={idx} className={`
                      flex items-center justify-center rounded-full font-bold shadow-md border-2 border-stone-700/20
                      ${plate >= 20 ? 'w-16 h-16 bg-red-600 text-white' : 
                        plate >= 10 ? 'w-14 h-14 bg-blue-600 text-white' : 
                        'w-10 h-10 bg-stone-300 text-black'}
                    `}>
                      {plate}
                    </div>
                  ))}
                </div>
              </>
            ) : (
               <p className="opacity-40 italic text-center">Introduce un peso mayor a la barra para ver los discos.</p>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// --- EXTRACTED VIEWS (To Prevent Re-renders lose focus) ---

const HomeView = ({ setView, accentText, buttonPrimary, darkMode }) => {
  const [quote] = useState(() => MOTIVATIONAL_QUOTES[Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length)]);

  return (
    <div className="pt-24 pb-12 px-4 max-w-4xl mx-auto animate-fade-in">
      <div className="text-center mb-12">
        <p className={`text-sm uppercase tracking-[0.3em] mb-4 ${accentText} font-bold`}>
          Bienvenido al cambio
        </p>
        <h1 className="text-5xl md:text-6xl font-serif font-bold mb-6 leading-tight">
          Descubre tu<br/>Verdadera <span className="italic font-light text-amber-500">Fuerza</span>
        </h1>
        <div className={`max-w-2xl mx-auto p-6 rounded-lg ${darkMode ? 'bg-stone-900/50' : 'bg-stone-100'}`}>
          <p className="italic text-lg opacity-80 font-serif">"{quote}"</p>
        </div>
      </div>

      <div className="space-y-6 text-lg leading-relaxed opacity-90 font-serif text-justify md:text-center">
        <p>
          Hola, soy Antonio. Hace más de dos años decidí que el gimnasio sería mi templo de cambio, 
          no solo físico, sino mental. Aquí no solo levanto pesas; desafío mis propios límites.
        </p>
        <p>
          He aprendido que el progreso real vive en la <strong>constancia</strong> y la <strong>disciplina</strong>. 
          Mi cuerpo cambió, pero mi mente se transformó por completo.
        </p>
        <p>
          He creado <strong>Anzo's Style</strong> para compartir contigo las rutinas que me han forjado. 
          No es solo mi viaje, es la herramienta para que comiences el tuyo.
        </p>
      </div>

      <div className="mt-16 text-center">
        <button 
          onClick={() => setView('routine-select')}
          className={`px-10 py-4 rounded-full text-xl font-bold tracking-wide ${buttonPrimary}`}
        >
          Comenzar Rutina
        </button>
      </div>
    </div>
  );
};

const InfoView = ({ routineId, setView, setSelectedRoutineId, setTimerVisible, setTimerRunning, cardClass, accentText, buttonPrimary }) => {
  const routine = ROUTINES[routineId];
  if (!routine) return null;

  return (
    <div className="pt-24 pb-12 px-4 max-w-5xl mx-auto animate-fade-in">
      <div className="mb-8 flex items-center gap-4">
        <button onClick={() => setView('home')} className="text-stone-500 hover:text-amber-500 transition-colors">
          &larr; Volver
        </button>
        <span className="opacity-30">|</span>
        <h2 className="text-3xl font-serif font-bold">{routine.title}</h2>
      </div>

      <div className="w-full h-64 md:h-96 bg-stone-800 rounded-2xl mb-12 overflow-hidden relative shadow-2xl group">
        <img 
          src={`/api/placeholder/800/400`} 
          alt={routine.title}
          className="w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-opacity duration-700"
        />
        <div className="absolute bottom-0 left-0 p-8 bg-gradient-to-t from-black/90 to-transparent w-full">
          <p className="text-xl text-stone-300 italic font-serif">{routine.description}</p>
        </div>
      </div>

      <div className="grid gap-8 md:grid-cols-2">
        {routine.blocks.map((block, idx) => (
          <div key={idx} className={`p-6 rounded-xl border transition-all hover:border-amber-500/30 ${cardClass}`}>
            <h3 className={`text-xl font-bold mb-4 ${accentText}`}>{block.title}</h3>
            <ul className="space-y-4">
              {block.exercises.map((ex, i) => (
                <li key={i} className="flex items-start gap-3">
                  <div className="mt-1.5 w-2 h-2 rounded-full bg-amber-500 flex-shrink-0" />
                  <div>
                    <p className="font-semibold text-lg">{ex.name}</p>
                    <p className="text-sm opacity-70 font-mono">{ex.details}</p>
                  </div>
                </li>
              ))}
            </ul>
          </div>
        ))}
      </div>
      
      <div className="mt-12 text-center">
           <button 
              onClick={() => {
                  setSelectedRoutineId(routineId);
                  setView('active-workout');
                  setTimerVisible(true);
                  setTimerRunning(true);
              }}
              className={`px-8 py-3 rounded-full font-bold ${buttonPrimary}`}
           >
               Entrenar {routine.title} Ahora
           </button>
      </div>
    </div>
  );
};

const RoutineSelectionView = ({ setSelectedRoutineId, setView, setTimerVisible, setTimerRunning, cardClass }) => {
  return (
    <div className="pt-24 pb-12 px-4 max-w-6xl mx-auto animate-fade-in">
      <h2 className="text-4xl font-serif font-bold text-center mb-12">Selecciona tu Batalla de Hoy</h2>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
        {Object.values(ROUTINES).map((routine) => (
          <div 
            key={routine.id}
            onClick={() => {
              setSelectedRoutineId(routine.id);
              setView('active-workout');
              setTimerVisible(true);
              setTimerRunning(true);
            }}
            className={`relative group cursor-pointer overflow-hidden rounded-2xl border transition-all duration-500 transform hover:-translate-y-2 hover:shadow-2xl ${cardClass}`}
          >
             <div className="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-all z-10" />
             <div className="h-64 w-full bg-stone-800 flex items-center justify-center overflow-hidden">
                <div className="text-stone-600 font-bold text-6xl opacity-20 group-hover:scale-110 transition-transform duration-700">
                  {routine.title.substring(0, 2)}
                </div>
             </div>
             
             <div className="absolute bottom-0 left-0 w-full p-6 z-20 bg-gradient-to-t from-black via-black/80 to-transparent">
               <h3 className="text-2xl font-bold text-white mb-1">{routine.title}</h3>
               <p className="text-amber-400 text-sm opacity-0 group-hover:opacity-100 transform translate-y-4 group-hover:translate-y-0 transition-all duration-300">
                 Comenzar Entrenamiento &rarr;
               </p>
             </div>
          </div>
        ))}
      </div>
    </div>
  );
};

const ActiveWorkoutView = ({ 
  routine, 
  currentWorkoutData, 
  setCurrentWorkoutData, 
  workoutNotes, 
  setWorkoutNotes, 
  handleFinishWorkout, 
  setShowPlateCalc, 
  darkMode, 
  cardClass 
}) => {
  const updateExercise = (exerciseName, field, value) => {
    setCurrentWorkoutData(prev => ({
      ...prev,
      [exerciseName]: {
        ...(prev[exerciseName] || { sets: 0, reps: 0, weight: '', completed: false }), // Ensure previous state exists
        [field]: value
      }
    }));
  };

  const toggleCompletion = (exerciseName) => {
      const current = currentWorkoutData[exerciseName]?.completed || false;
      updateExercise(exerciseName, 'completed', !current);
  };

  const totalExercises = routine.blocks.reduce((acc, block) => acc + block.exercises.length, 0);
  const completedCount = Object.values(currentWorkoutData).filter(e => e.completed).length;
  const progress = Math.round((completedCount / totalExercises) * 100);

  return (
    <div className="pt-24 pb-24 px-4 max-w-4xl mx-auto animate-fade-in">
      {/* Header Sticky */}
      <div className={`sticky top-16 z-30 py-4 mb-8 backdrop-blur-xl border-b ${darkMode ? 'bg-stone-950/80 border-stone-800' : 'bg-white/80 border-stone-200'}`}>
        <div className="flex justify-between items-center mb-2">
          <h2 className="text-xl font-bold truncate">{routine.title}</h2>
          <div className="flex items-center gap-3">
             <button 
                onClick={() => setShowPlateCalc(true)}
                className="flex items-center gap-1 text-xs bg-stone-500/20 hover:bg-stone-500/30 px-2 py-1 rounded-full transition-colors"
             >
                <Disc size={14} className="text-amber-500" /> Calc
             </button>
             <span className="font-mono text-amber-500 font-bold">{progress}%</span>
          </div>
        </div>
        <div className="w-full h-2 bg-stone-700 rounded-full overflow-hidden">
          <div 
            className="h-full bg-amber-500 transition-all duration-500 ease-out"
            style={{ width: `${progress}%` }}
          />
        </div>
      </div>

      <div className="space-y-8">
        {routine.blocks.map((block, bIdx) => (
          <div key={bIdx} className="animate-slide-up" style={{ animationDelay: `${bIdx * 100}ms` }}>
            <h3 className="text-sm uppercase tracking-widest opacity-60 mb-4 ml-1">{block.title}</h3>
            <div className="space-y-4">
              {block.exercises.map((ex, eIdx) => {
                // FIX: Merge with default object to ensure no undefined values cause "uncontrolled" error
                const storedData = currentWorkoutData[ex.name] || {};
                const data = { sets: 0, reps: 0, weight: '', completed: false, ...storedData };
                
                return (
                  <div 
                    key={ex.name} 
                    className={`p-4 rounded-xl border transition-all ${data.completed ? (darkMode ? 'bg-green-900/10 border-green-900/30' : 'bg-green-50 border-green-200') : cardClass}`}
                  >
                    <div className="flex justify-between items-start mb-4">
                      <div>
                        <h4 className={`font-bold text-lg ${data.completed ? 'text-green-500' : ''}`}>{ex.name}</h4>
                        <p className="text-xs opacity-60 mt-1">{ex.details}</p>
                      </div>
                      <button 
                        onClick={() => toggleCompletion(ex.name)}
                        className={`p-2 rounded-full transition-all ${data.completed ? 'bg-green-500 text-white' : 'bg-stone-700/20 text-stone-400 hover:bg-stone-700/40'}`}
                      >
                        <CheckCircle size={24} />
                      </button>
                    </div>

                    <div className={`grid grid-cols-3 gap-4 transition-opacity duration-300 ${data.completed ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                      <div className="flex flex-col items-center">
                         <label className="text-[10px] uppercase tracking-wider opacity-60 mb-1">Series</label>
                         <div className="flex items-center gap-2 bg-stone-500/10 rounded-lg p-1">
                            <button 
                              className="w-8 h-8 flex items-center justify-center hover:bg-stone-500/20 rounded"
                              onClick={() => updateExercise(ex.name, 'sets', Math.max(0, (data.sets || 0) - 1))}
                            >-</button>
                            <span className="font-mono w-6 text-center font-bold">{data.sets || 0}</span>
                            <button 
                              className="w-8 h-8 flex items-center justify-center hover:bg-stone-500/20 rounded"
                              onClick={() => updateExercise(ex.name, 'sets', (data.sets || 0) + 1)}
                            >+</button>
                         </div>
                      </div>

                      <div className="flex flex-col items-center">
                         <label className="text-[10px] uppercase tracking-wider opacity-60 mb-1">Reps</label>
                         <div className="flex items-center gap-2 bg-stone-500/10 rounded-lg p-1">
                            <button 
                              className="w-8 h-8 flex items-center justify-center hover:bg-stone-500/20 rounded"
                              onClick={() => updateExercise(ex.name, 'reps', Math.max(0, (data.reps || 0) - 1))}
                            >-</button>
                            <span className="font-mono w-6 text-center font-bold">{data.reps || 0}</span>
                            <button 
                              className="w-8 h-8 flex items-center justify-center hover:bg-stone-500/20 rounded"
                              onClick={() => updateExercise(ex.name, 'reps', (data.reps || 0) + 1)}
                            >+</button>
                         </div>
                      </div>

                      <div className="flex flex-col items-center">
                         <label className="text-[10px] uppercase tracking-wider opacity-60 mb-1">Peso (Kg)</label>
                         <div className="flex items-center gap-2 bg-stone-500/10 rounded-lg p-1 w-full">
                            <button 
                              className="w-8 h-8 flex-shrink-0 flex items-center justify-center hover:bg-stone-500/20 rounded"
                              onClick={() => {
                                  const current = parseFloat(data.weight) || 0;
                                  updateExercise(ex.name, 'weight', Math.max(0, current - 2.5)); 
                              }}
                            >-</button>
                            <input 
                              type="number" 
                              placeholder="0"
                              className="w-full text-center bg-transparent font-mono font-bold focus:outline-none focus:ring-0 appearance-none" 
                              value={data.weight}
                              onChange={(e) => updateExercise(ex.name, 'weight', e.target.value)}
                              onClick={(e) => e.target.select()} 
                            />
                            <button 
                              className="w-8 h-8 flex-shrink-0 flex items-center justify-center hover:bg-stone-500/20 rounded"
                              onClick={() => {
                                   const current = parseFloat(data.weight) || 0;
                                   updateExercise(ex.name, 'weight', current + 2.5); 
                              }}
                            >+</button>
                         </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        ))}
      </div>

      {/* Workout Journal Section */}
      <div className={`mt-8 p-6 rounded-xl border ${cardClass}`}>
         <h3 className="text-lg font-bold mb-3 flex items-center gap-2"><BookOpen size={18}/> Diario de Sensaciones</h3>
         <textarea
           className="w-full bg-transparent border border-stone-500/20 rounded-lg p-3 focus:outline-none focus:border-amber-500 transition-colors min-h-[100px] text-sm"
           placeholder="¿Cómo te sentiste hoy? ¿Alguna molestia? ¿Mucha energía?..."
           value={workoutNotes}
           onChange={(e) => setWorkoutNotes(e.target.value)}
         />
      </div>

      <div className="mt-8 mb-8">
         <button 
           onClick={handleFinishWorkout}
           className="w-full py-4 rounded-xl font-bold bg-gradient-to-r from-amber-600 to-orange-600 text-white shadow-lg hover:shadow-amber-900/30 transform hover:scale-[1.02] transition-all"
         >
           Suficiente por hoy (Finalizar)
         </button>
      </div>
    </div>
  );
};

const StatsView = ({ history, cardClass }) => {
  const totalWorkouts = history.length;
  const [rmWeight, setRmWeight] = useState('');
  const [rmReps, setRmReps] = useState('');
  const calculated1RM = rmWeight && rmReps ? Math.round(rmWeight * (1 + (rmReps / 30))) : 0;

  const getHeatmapData = () => {
    const last30Days = [...Array(30)].map((_, i) => {
      const d = new Date();
      d.setDate(d.getDate() - (29 - i));
      return d.toISOString().split('T')[0];
    });
    
    return last30Days.map(dateStr => {
      const count = history.filter(h => h.date.startsWith(dateStr)).length;
      return { date: dateStr, count };
    });
  };
  const heatmapData = getHeatmapData();

  return (
    <div className="pt-24 pb-12 px-4 max-w-5xl mx-auto animate-fade-in">
      <h2 className="text-4xl font-serif font-bold mb-8">Tu Progreso</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className={`p-6 rounded-xl border ${cardClass} flex items-center gap-4`}>
              <div className="p-4 rounded-full bg-amber-500/20 text-amber-500">
                  <Trophy size={24} />
              </div>
              <div>
                  <p className="text-sm opacity-60 uppercase">Total Sesiones</p>
                  <p className="text-3xl font-bold">{totalWorkouts}</p>
              </div>
          </div>
          {/* Heatmap Widget */}
          <div className={`col-span-1 md:col-span-2 p-6 rounded-xl border ${cardClass} flex flex-col justify-center`}>
              <div className="flex items-center gap-2 mb-4">
                 <Activity size={20} className="text-amber-500"/>
                 <p className="text-sm opacity-60 uppercase font-bold">Constancia (Últimos 30 días)</p>
              </div>
              <div className="flex items-end gap-1 h-16 w-full">
                 {heatmapData.map((d, i) => (
                   <div 
                     key={i}
                     className={`flex-1 rounded-t-sm transition-all hover:opacity-80 relative group ${d.count > 0 ? 'bg-amber-500' : 'bg-stone-500/10'}`}
                     style={{ height: d.count > 0 ? '100%' : '20%' }}
                   >
                      {/* Tooltip */}
                      <div className="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap pointer-events-none z-10">
                        {d.date.slice(5)}: {d.count}
                      </div>
                   </div>
                 ))}
              </div>
          </div>
      </div>

      <div className={`mb-12 p-6 rounded-xl border ${cardClass}`}>
          <h3 className="font-bold text-xl mb-4 flex items-center gap-2"><Dumbbell size={20}/> Calculadora Rápida 1RM</h3>
          <div className="flex gap-4 items-end">
              <div>
                  <label className="text-xs uppercase block mb-1">Peso (kg)</label>
                  <input type="number" value={rmWeight} onChange={e=>setRmWeight(e.target.value)} className="w-24 p-2 rounded bg-stone-500/10" />
              </div>
              <div>
                  <label className="text-xs uppercase block mb-1">Reps</label>
                  <input type="number" value={rmReps} onChange={e=>setRmReps(e.target.value)} className="w-24 p-2 rounded bg-stone-500/10" />
              </div>
              <div className="pb-2">
                  <span className="text-2xl font-bold text-amber-500">{calculated1RM} kg</span> <span className="text-xs opacity-50">Est. Max</span>
              </div>
          </div>
      </div>

      <div className="flex justify-between items-center mb-6">
          <h3 className="text-2xl font-serif font-bold">Historial Reciente</h3>
          <button 
              onClick={() => exportToCSV(history)}
              className="flex items-center gap-2 px-4 py-2 rounded-lg bg-stone-800 hover:bg-stone-700 text-white transition-colors text-sm"
          >
              <Download size={16} /> Exportar Excel
          </button>
      </div>

      <div className="space-y-4">
          {history.length === 0 ? (
              <div className="text-center py-12 opacity-40">Aún no hay registros. ¡A entrenar!</div>
          ) : (
              history.slice(0, 10).map((session) => (
                  <div key={session.id} className={`p-4 rounded-xl border ${cardClass}`}>
                      <div className="flex justify-between items-center mb-2">
                          <div>
                              <p className="font-bold text-lg">{session.routineName}</p>
                              <p className="text-sm opacity-60">{new Date(session.date).toLocaleDateString()} &bull; {formatTime(session.duration || 0)}</p>
                          </div>
                          <div className="text-right">
                              <p className="font-mono text-sm">{Object.keys(session.exercises).length} Ejer.</p>
                          </div>
                      </div>
                      {session.notes && (
                        <div className="mt-2 pt-2 border-t border-stone-500/10">
                           <p className="text-xs italic opacity-70">"{session.notes}"</p>
                        </div>
                      )}
                  </div>
              ))
          )}
      </div>
    </div>
  );
};

// --- MAIN APP ---

export default function AnzosStyleApp() {
  const [loading, setLoading] = useState(true);
  const [darkMode, setDarkMode] = useState(true); 
  const [view, setView] = useState('home'); 
  const [selectedRoutineId, setSelectedRoutineId] = useState(null);
  const [history, setHistory] = useState([]);
  const [showSettings, setShowSettings] = useState(false);
  const [toast, setToast] = useState({ show: false, msg: '' });
  const [showPlateCalc, setShowPlateCalc] = useState(false);
  const [timerTime, setTimerTime] = useState(0);
  const [timerRunning, setTimerRunning] = useState(false);
  const [timerVisible, setTimerVisible] = useState(false);
  const [currentWorkoutData, setCurrentWorkoutData] = useState({}); 
  const [workoutNotes, setWorkoutNotes] = useState(''); 

  useEffect(() => {
    const savedHistory = localStorage.getItem('anzos_history');
    const savedTheme = localStorage.getItem('anzos_theme');
    if (savedHistory) setHistory(JSON.parse(savedHistory));
    if (savedTheme) setDarkMode(savedTheme === 'dark');
  }, []);

  useEffect(() => {
    localStorage.setItem('anzos_theme', darkMode ? 'dark' : 'light');
    if (darkMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [darkMode]);

  useEffect(() => {
    let interval = null;
    if (timerRunning) {
      interval = setInterval(() => {
        setTimerTime(prev => prev + 1);
      }, 1000);
    } else if (!timerRunning && timerTime !== 0) {
      clearInterval(interval);
    }
    return () => clearInterval(interval);
  }, [timerRunning, timerTime]);

  const [showScrollTop, setShowScrollTop] = useState(false);
  useEffect(() => {
    const checkScroll = () => {
      if (window.scrollY > 300) setShowScrollTop(true);
      else setShowScrollTop(false);
    };
    window.addEventListener('scroll', checkScroll);
    return () => window.removeEventListener('scroll', checkScroll);
  }, []);

  const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });

  const handleFinishWorkout = () => {
    if (Object.keys(currentWorkoutData).length === 0) {
      showToast("No has registrado ningún ejercicio.");
      return;
    }

    const newRecord = {
      id: Date.now(),
      date: new Date().toISOString(),
      routineId: selectedRoutineId,
      routineName: ROUTINES[selectedRoutineId].title,
      exercises: currentWorkoutData,
      duration: timerTime,
      notes: workoutNotes 
    };

    const updatedHistory = [newRecord, ...history];
    setHistory(updatedHistory);
    localStorage.setItem('anzos_history', JSON.stringify(updatedHistory));
    
    showToast("¡Entrenamiento guardado!");
    setCurrentWorkoutData({});
    setWorkoutNotes('');
    setTimerRunning(false);
    setTimerTime(0);
    setTimerVisible(false);
    setView('home');
    scrollToTop();
  };

  const showToast = (msg) => {
    setToast({ show: true, msg });
  };

  if (loading) return <InitialLoader onFinish={() => setLoading(false)} />;

  const bgClass = darkMode ? "bg-stone-950 text-stone-200" : "bg-stone-50 text-stone-800";
  const cardClass = darkMode ? "bg-stone-900 border-stone-800" : "bg-white border-stone-200";
  const accentText = darkMode ? "text-amber-500" : "text-amber-700";
  const buttonPrimary = "bg-amber-600 hover:bg-amber-700 text-white shadow-lg shadow-amber-900/20 transition-all transform hover:scale-105 active:scale-95";
  
  // --- GLOBAL COMPONENTS (INTERNAL) ---

  const Navbar = () => {
    const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
    
    const navLinks = [
      { name: "Comenzar Rutina", id: 'routine-select' },
      { name: "Pecho y Tríceps", id: 'info-chest' },
      { name: "Espalda y Bíceps", id: 'info-back' },
      { name: "Pierna", id: 'info-legs' },
      { name: "Deltoides", id: 'info-delts' },
      { name: "Estadísticas", id: 'stats' },
    ];

    return (
      <nav className={`fixed top-0 w-full z-40 backdrop-blur-md border-b ${darkMode ? 'bg-stone-950/80 border-stone-800' : 'bg-white/80 border-stone-200'} transition-all`}>
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            <div 
              className="flex-shrink-0 flex items-center cursor-pointer group" 
              onClick={() => setView('home')}
            >
              <Dumbbell className={`h-6 w-6 mr-2 ${accentText} group-hover:rotate-12 transition-transform`} />
              <span className={`font-serif font-bold text-xl tracking-wider ${darkMode ? 'text-white' : 'text-stone-900'}`}>
                Anzo's Style
              </span>
            </div>

            <div className="hidden md:block">
              <div className="ml-10 flex items-baseline space-x-4">
                {navLinks.map(link => (
                  <button
                    key={link.name}
                    onClick={() => setView(link.id)}
                    className={`px-3 py-2 rounded-md text-sm font-medium transition-colors ${view === link.id ? accentText : 'text-stone-500 hover:text-amber-600'}`}
                  >
                    {link.name}
                  </button>
                ))}
              </div>
            </div>

            <div className="hidden md:flex items-center space-x-4">
              <button 
                onClick={() => setShowSettings(true)}
                className="p-2 rounded-full hover:bg-stone-800/10 transition-colors"
              >
                <Settings size={20} className={darkMode ? 'text-stone-300' : 'text-stone-600'} />
              </button>
            </div>

            <div className="-mr-2 flex md:hidden">
              <button 
                onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                className="p-2 rounded-md text-stone-400 hover:text-white hover:bg-stone-800"
              >
                {mobileMenuOpen ? <X size={24} /> : <Menu size={24} />}
              </button>
            </div>
          </div>
        </div>

        {mobileMenuOpen && (
          <div className="md:hidden bg-stone-900 border-t border-stone-800">
            <div className="px-2 pt-2 pb-3 space-y-1 sm:px-3">
              {navLinks.map(link => (
                <button
                  key={link.name}
                  onClick={() => {
                    setView(link.id);
                    setMobileMenuOpen(false);
                  }}
                  className="block px-3 py-2 rounded-md text-base font-medium w-full text-left text-stone-300 hover:text-white hover:bg-stone-800"
                >
                  {link.name}
                </button>
              ))}
              <button
                onClick={() => { setShowSettings(true); setMobileMenuOpen(false); }}
                className="flex items-center px-3 py-2 w-full text-left text-stone-300 hover:text-white"
              >
                <Settings size={18} className="mr-2" /> Configuración
              </button>
            </div>
          </div>
        )}
      </nav>
    );
  };

  const SettingsModal = () => {
    if (!showSettings) return null;
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div className={`w-full max-w-md p-6 rounded-xl shadow-2xl border ${cardClass}`}>
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-serif font-bold">Configuración</h2>
            <button onClick={() => setShowSettings(false)}><X size={24} /></button>
          </div>
          
          <div className="space-y-6">
            <div className="flex items-center justify-between p-4 rounded-lg bg-stone-100 dark:bg-stone-950/50">
              <div className="flex items-center gap-3">
                {darkMode ? <Moon size={20} className="text-indigo-400"/> : <Sun size={20} className="text-orange-500"/>}
                <span className="font-medium">Modo Oscuro</span>
              </div>
              <button 
                onClick={() => setDarkMode(!darkMode)}
                className={`w-12 h-6 rounded-full p-1 transition-colors duration-300 ${darkMode ? 'bg-amber-600' : 'bg-stone-300'}`}
              >
                <div className={`w-4 h-4 rounded-full bg-white transform transition-transform ${darkMode ? 'translate-x-6' : ''}`} />
              </button>
            </div>

            <div className="p-4 rounded-lg border border-red-500/30 bg-red-500/5">
              <h3 className="text-red-500 font-bold mb-2">Zona de Peligro</h3>
              <p className="text-sm mb-4 opacity-80">Esto borrará todo tu historial de entrenamientos.</p>
              <button 
                onClick={() => {
                  if(confirm("¿Estás seguro? Esta acción es irreversible.")) {
                    setHistory([]);
                    localStorage.removeItem('anzos_history');
                    showToast("Historial eliminado");
                    setShowSettings(false);
                  }
                }}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm w-full transition-colors"
              >
                Reiniciar Estadísticas
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const GlobalTimer = () => {
    return (
      <div className={`fixed bottom-4 left-4 z-40 transition-all duration-500 ${timerVisible || timerRunning ? 'translate-y-0 opacity-100' : 'translate-y-20 opacity-0'}`}>
        <div className={`flex items-center gap-3 p-3 rounded-full shadow-2xl backdrop-blur-md border ${darkMode ? 'bg-stone-900/90 border-stone-700' : 'bg-white/90 border-stone-200'}`}>
          <div className={`font-mono text-xl font-bold w-20 text-center ${accentText}`}>
            {formatTime(timerTime)}
          </div>
          <div className="flex gap-1">
            <button 
              onClick={() => setTimerRunning(!timerRunning)}
              className={`p-2 rounded-full ${timerRunning ? 'bg-amber-500/20 text-amber-500' : 'bg-green-500/20 text-green-500'}`}
            >
              {timerRunning ? <Pause size={18} /> : <Play size={18} />}
            </button>
            <button 
              onClick={() => { setTimerRunning(false); setTimerTime(0); }}
              className="p-2 rounded-full hover:bg-stone-500/20 text-stone-500"
            >
              <RotateCcw size={18} />
            </button>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className={`min-h-screen transition-colors duration-500 font-sans ${bgClass}`}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400&family=Merriweather:wght@300;400;700&display=swap');
        .font-serif { font-family: 'Lora', serif; }
        .font-display { font-family: 'Merriweather', serif; }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
          display: none;
        }
        .no-scrollbar {
          -ms-overflow-style: none;  /* IE and Edge */
          scrollbar-width: none;  /* Firefox */
        }

        /* Hide standard number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
      `}</style>

      <Navbar />
      
      <main className="relative z-0">
        {view === 'home' && (
          <HomeView 
            setView={setView}
            accentText={accentText}
            buttonPrimary={buttonPrimary}
            darkMode={darkMode}
          />
        )}

        {view.startsWith('info-') && (
          <InfoView 
            routineId={view.replace('info-', '')}
            setView={setView}
            setSelectedRoutineId={setSelectedRoutineId}
            setTimerVisible={setTimerVisible}
            setTimerRunning={setTimerRunning}
            cardClass={cardClass}
            accentText={accentText}
            buttonPrimary={buttonPrimary}
          />
        )}

        {view === 'routine-select' && (
          <RoutineSelectionView 
            setSelectedRoutineId={setSelectedRoutineId}
            setView={setView}
            setTimerVisible={setTimerVisible}
            setTimerRunning={setTimerRunning}
            cardClass={cardClass}
          />
        )}

        {view === 'active-workout' && selectedRoutineId && (
          <ActiveWorkoutView 
            routine={ROUTINES[selectedRoutineId]}
            currentWorkoutData={currentWorkoutData}
            setCurrentWorkoutData={setCurrentWorkoutData}
            workoutNotes={workoutNotes}
            setWorkoutNotes={setWorkoutNotes}
            handleFinishWorkout={handleFinishWorkout}
            setShowPlateCalc={setShowPlateCalc}
            darkMode={darkMode}
            cardClass={cardClass}
          />
        )}

        {view === 'stats' && (
          <StatsView 
            history={history}
            cardClass={cardClass}
          />
        )}
      </main>

      <GlobalTimer />
      
      {showPlateCalc && (
        <PlateCalculator 
          onClose={() => setShowPlateCalc(false)} 
          cardClass={cardClass}
        />
      )}
      
      <SettingsModal />
      
      <Toast show={toast.show} message={toast.msg} onClose={() => setToast({ ...toast, show: false })} />

      {showScrollTop && (
        <button 
          onClick={scrollToTop}
          className="fixed bottom-4 right-4 z-30 p-3 rounded-full bg-amber-600 text-white shadow-lg hover:bg-amber-700 transition-all animate-bounce-short"
        >
          <ChevronUp size={24} />
        </button>
      )}
    </div>
  );
}
